syntax = "proto3";

package inventory;

import "google/api/annotations.proto";

option go_package = "github.com/djgupt/remote-inventory/proto";

// Session management and video streaming service
service RemoteInventoryService {
  // Create a new session for a provider
  rpc CreateSession(CreateSessionRequest) returns (SessionResponse) {
    option (google.api.http) = {
      post: "/v1/sessions"
      body: "*"
    };
  }

  // List all active sessions (for consumers to discover providers)
  rpc ListSessions(ListSessionsRequest) returns (ListSessionsResponse) {
    option (google.api.http) = {
      get: "/v1/sessions"
    };
  }

  // Consumer requests to connect to a provider session
  rpc RequestConnection(ConnectionRequest) returns (ConnectionResponse) {
    option (google.api.http) = {
      post: "/v1/sessions/{session_id}/connect"
      body: "*"
    };
  }

  // Provider watches for incoming connection requests
  rpc WatchConnectionRequests(WatchRequestsRequest) returns (stream ConnectionRequestNotification) {}

  // Provider approves a connection request
  rpc ApproveConnection(ApproveRequest) returns (ApproveResponse) {
    option (google.api.http) = {
      post: "/v1/requests/{request_id}/approve"
      body: "*"
    };
  }

  // Provider denies a connection request
  rpc DenyConnection(DenyRequest) returns (DenyResponse) {
    option (google.api.http) = {
      post: "/v1/requests/{request_id}/deny"
      body: "*"
    };
  }

  // Consumer watches for approval status
  rpc WatchApprovalStatus(WatchApprovalRequest) returns (stream ApprovalStatusUpdate) {}

  // Streaming video (existing)
  rpc StreamVideo(stream VideoFrame) returns (stream VideoFrame) {}

  // Send command to provider (existing)
  rpc SendCommand(Command) returns (CommandResponse) {
    option (google.api.http) = {
      post: "/v1/sessions/{session_id}/commands"
      body: "*"
    };
  }

  rpc EndSession(EndSessionRequest) returns (EndSessionResponse) {
    option (google.api.http) = {
      delete: "/v1/sessions/{session_id}"
    };
  }
  // Bidirectional streaming for Provider video upload and command reception
  rpc ProviderStream(stream ProviderMessage) returns (stream ProviderCommand);
  
  // Consumer receives privacy-blurred video and sends commands
  rpc ConsumerStream(stream ConsumerCommand) returns (stream VideoFrame);
  
  // Heartbeat to keep sessions alive
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse) {
    option (google.api.http) = {
      post: "/v1/sessions/{session_id}/heartbeat"
      body: "*"
    };
  }
}

// Session messages
message CreateSessionRequest {
  string provider_id = 1;
  string provider_name = 2;
}

message JoinSessionRequest {
  string session_id = 1;
  string consumer_id = 2;
  string consumer_name = 3;
}

message SessionResponse {
  string session_id = 1;
  string token = 2;
  bool success = 3;
  string message = 4;
}

message EndSessionRequest {
  string session_id = 1;
  string token = 2;
}

message EndSessionResponse {
  bool success = 1;
}

// Provider messages
message ProviderMessage {
  string session_id = 1;
  string token = 2;
  oneof payload {
    VideoFrame video_frame = 3;
    SensorData sensor_data = 4;
    ProviderStatus status = 5;
  }
}

message VideoFrame {
  bytes frame_data = 1;  // JPEG encoded frame
  int64 timestamp_ms = 2;
  int32 width = 3;
  int32 height = 4;
  bool is_blurred = 5;  // Indicates if privacy processing is complete
}

message SensorData {
  float accelerometer_x = 1;
  float accelerometer_y = 2;
  float accelerometer_z = 3;
  float compass_heading = 4;
  float gyroscope_x = 5;
  float gyroscope_y = 6;
  float gyroscope_z = 7;
}

message ProviderStatus {
  bool camera_active = 1;
  int32 battery_level = 2;
}

// Provider receives commands from Consumer
message ProviderCommand {
  oneof command {
    NavigationCommand navigation = 1;
    LaserCommand laser = 2;
    StopCommand stop = 3;
    ZoomCommand zoom = 4;
  }
}

message NavigationCommand {
  enum Direction {
    UNKNOWN = 0;
    LEFT = 1;
    RIGHT = 2;
    UP = 3;
    DOWN = 4;
    FORWARD = 5;
    BACKWARD = 6;
  }
  Direction direction = 1;
  float intensity = 2;  // 0.0 to 1.0
}

message LaserCommand {
  bool active = 1;
  float screen_x = 2;  // Normalized 0.0 to 1.0
  float screen_y = 3;  // Normalized 0.0 to 1.0
}

message StopCommand {
  bool emergency = 1;
}

message ZoomCommand {
  enum ZoomType {
    IN = 0;
    OUT = 1;
    RESET = 2;
  }
  ZoomType type = 1;
  float level = 2;  // Current zoom level
}

// Consumer messages
message ConsumerCommand {
  string session_id = 1;
  string token = 2;
  oneof command {
    NavigationCommand navigation = 3;
    LaserCommand laser = 4;
    StopCommand stop = 5;
    ZoomCommand zoom = 6;
    VoiceCommand voice = 7;
    TextCommand text = 8;
  }
}

message VoiceCommand {
  string transcribed_text = 1;
  float confidence = 2;
}

message TextCommand {
  string text = 1;
}

// Heartbeat
message HeartbeatRequest {
  string session_id = 1;
  string token = 2;
  string role = 3;  // "provider" or "consumer"
}

message HeartbeatResponse {
  bool active = 1;
  int64 session_duration_ms = 2;
}

// Session Discovery Messages
message ListSessionsRequest {
  string search_query = 1;
}

message ListSessionsResponse {
  repeated SessionInfo sessions = 1;
}

message SessionInfo {
  string session_id = 1;
  string provider_name = 2;
  string provider_location = 3;
  int64 created_at = 4;
  bool accepting_connections = 5;
}

// Connection Request Messages
message ConnectionRequest {
  string session_id = 1;
  string consumer_id = 2;
  string consumer_name = 3;
}

message ConnectionResponse {
  string request_id = 1;
  bool success = 2;
  string message = 3;
}

message WatchRequestsRequest {
  string session_id = 1;
}

message ConnectionRequestNotification {
  string request_id = 1;
  string consumer_id = 2;
  string consumer_name = 3;
  int64 requested_at = 4;
}

// Approval Messages
message ApproveRequest {
  string request_id = 1;
}

message ApproveResponse {
  bool success = 1;
  string session_id = 2;
  string token = 3;
}

message DenyRequest {
  string request_id = 1;
  string reason = 2;
}

message DenyResponse {
  bool success = 1;
}

message WatchApprovalRequest {
  string request_id = 1;
}

message ApprovalStatusUpdate {
  enum Status {
    PENDING = 0;
    APPROVED = 1;
    DENIED = 2;
  }
  Status status = 1;
  string session_id = 2;
  string token = 3;
  string message = 4;
}

// Command Messages
message Command {
  string session_id = 1;
  oneof command_type {
    NavigationCommand navigation = 2;
    LaserCommand laser = 3;
    StopCommand stop = 4;
    ZoomCommand zoom = 5;
    VoiceCommand voice = 6;
    TextCommand text = 7;
  }
}

message CommandResponse {
  bool success = 1;
  string message = 2;
}
